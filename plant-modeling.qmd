---
title: "Predicting plant population trends from photosynthetic rate and threats"
author: "Sam Muir"
date: 12-10-2023
format: html
editor: visual
output:
    html_document:
      print_df: paged
      toc: yes
      toc_depth: 4
      toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r packages, include=FALSE}
library(tidyverse)
library(sjPlot)
library(generics)
library(patchwork)
library(kableExtra)
```

# Project Overview

## Motivation

Climate change and human activity are significant factors that threaten species populations. Nearly 40% of plant species are threatened worldwide, and even more are predicted to become threatened as effects of climate change and human activity continue. Many plant species that are threatened or endangered are not very resilient to conditions outside of their niche, often due to their physiological traits, such as carbon fixation.

C4 and CAM plants have a more efficient carbon fixation process and are generally more energy-efficient than C3 processes. Plants with high photosynthetic efficiency are often economically important as crops and more resilient to harsh environments. Interestingly, cacti, which use CAM, are one of the most threatened groups of plants, despite their high photosynthetic efficiency.

There are many other factors that affect a species' population trend, but in this project, I am interested in analyzing plant physiological and ecological traits to try to predict a plant's population trend based on the IUCN Red List.

# Data & Methods

Photosynthetic rate data was obtained from the `BIEN` R package. The Botanical Information and Ecology Network (BIEN) was developed by collaborating ecologists at the National Center for Ecological Analysis and Synthesis (NCEAS). The BIEN database contains a variety of information ranging from phylogeny data to species distribution. To determine population trend and if a species is threatened by climate change or human activity I obtained data from the IUCN Red List.

To analyze my data I ran a logistic regression. I used Increasing/Stable (0) and Decreasing (1) as the categorical binary response variable on average photosynthetic rare per leaf area, climate threatened, and human threatened. 

## Data Preparation

Data was prepared in the `data_fetch.R` script. Data from `BIEN` was cleaned and joined with data from the IUCN Red List entries for species in the kingdom *Plantae*. Species that had an increasing or stable population trend were assigned a binary variable of 0 and those who had a decreasing population trend were assigned a binary variable of 1. 

```{r}
source(file.path("data_fetch.R"))
```

## Data Exploration

```{r}
ggplot(join, aes(x = avg_photo)) +
  geom_histogram(fill = "seagreen", color = "black") +
  theme_linedraw() +
  labs(x = "Avg. Photosynthetic Rate per Leaf Area (Âµmol m-2 s-1)")
```

```{r}
ggplot(data = join, aes(x = avg_photo, y = pop_trend)) + 
  geom_jitter(width = 0, height = 0.05, alpha = 0.8) +
  theme_linedraw() +
  labs(x = "Avg. Photosynthetic Rate per Leaf Area (Âµmol m-2 s-1)", 
       y = "Population Trend")
```

```{r}
clim_plot <- ggplot(clim_human, aes(x = climate_threatened)) +
  geom_bar(width = 0.5, fill = "seagreen", color = "black") +
  theme_linedraw() +
  labs(x = "Climate threatened?")

human_plot <- ggplot(clim_human, aes(x = human_threatened)) +
  geom_bar(width = 0.5, fill = "seagreen", color = "black") +
  theme_linedraw() +
  labs(x = "Human threatened?", y = "")

clim_plot + human_plot
```

# Analysis

## Logistic Regression for Average Photosynthetic Rate

##### $$\operatorname{logit}(p)=\log \left(\frac{p}{1-p}\right)=\beta_0+\beta_1  (Photosynthetic Rate)  +\varepsilon $$

```{r}
ggplot(join, aes(x = avg_photo, y = pop_trend_binary)) + 
  geom_jitter(width = 0, height = 0.05, alpha = 0.8) +
  geom_smooth(method = "glm", se = FALSE, color = "red", 
              method.args = list(family = "binomial")) +
  theme_linedraw() +
  labs(x = "Avg. Photosynthetic Rate per Leaf Area (Âµmol m-2 s-1)", 
       y = "Binary Population Trend",
       title = "Generalized Linear Model")
```

```{r}
# model
mod_photo <- glm(pop_trend_binary ~ avg_photo, 
                  data = join, 
                  family = "binomial")

# model table
sjPlot::tab_model(mod_photo,
          transform = NULL,
          pred.labels = c("Intercept", "Avg. Photosynthetic Rate (Âµmol m-2 s-1)"),
          show.p = TRUE,
          p.style = c("numeric_stars"),
          p.threshold = c(0.10, 0.05, 0.01),
          dv.labels = c("log Threat Pobability"),
          string.p = "p-value",
          show.r2 = FALSE,
          title = "Logisitc Regression Model Results for Photosynthetic Rate",
          digits = 3)
```

```{r}
# compute fitted prob.
photo_fitted <- mod_photo %>%
  augment(type.predict = "response") %>%
  mutate(y_hat = .fitted)
# compute odds
photo_fitted <- photo_fitted %>% 
  mutate(odds_hat = y_hat / (1 - y_hat)) 

# plot
ggplot(photo_fitted, aes(x = avg_photo, y = odds_hat)) +
  geom_point(size = 1) + 
  geom_line() + 
  scale_y_continuous("Log-odds of being threatened") +
  labs(x = "Avg. Photosynthetic Rate (Âµmol m-2 s-1)", 
       title = "Log-odds of being threatened by photosynthetic rate") +
  theme_linedraw()
```

## Omitted Variables

This first model only considered photosynthetic rate, but now we want to add in if the species is threatened by climate change or human activity 

```{r}
mod <- glm(pop_trend_binary ~ avg_photo + climate_threatened + human_threatened,
           data = clim_human,
           family = "binomial")

tab_model(mod,
          transform = NULL,
          pred.labels = c("Intercept", "Average Photosyntheitc Rate (Âµmol m-2 s-1)", 
                          "Climate Threatened", "Human Threatened"),
          p.style = c("numeric_stars"),
          p.threshold = c(0.10, 0.05, 0.01),
          show.p = TRUE,
          string.p = "p-value",
          dv.labels = c("log Threat Pobability"),
          show.r2 = FALSE,
          title = "Logisitc Regression Model Results for Photosynthetic Rate, Climate Threatened, and Human Threatened",
          digits = 3)
```

From this model we can see that at 95% confidence, average photosynthetic rate (p<0.001) and if a species is threatened by climate factors (p<0.001) are significant predictors of population trend, but human threatened is not (p=0.706). Based on this model, I conclude that for each unit increase in photosynthetic rate, the log-odds of a species being threatened decreases by `r mod$coefficients[2]`.

## Making Predictions

There are many species from the BIEN data that are not present on the IUCN Red List. Here, I am using my model to try to predict if an unlisted species population trend. To do this, I'll need to pull of the model coefficients and create a function with inputs for the coefficients, photosynthetic rate, if it is threatened by climate change, and if it is threatened by human activities. 

```{r}
# coefficients
b0 <- mod$coefficients[1] #Intercept
b1 <- mod$coefficients[2] #photo
b2 <- mod$coefficients[3] #climate
b3 <- mod$coefficients[4] #human

# Function for testing probabilities
threat_prob <- function(b0, b1, b2, b3, photo, climate, human) {
  equ <- b0 + b1 * photo + b2 * climate + b3 * human
  prob <- (exp(equ)) / (1 + exp(equ))
  print(prob)
}

# Testing probabilities for species with the highest and lowest photosynthetic rates
threat_prob(b0, b1, b2, b3, 47.06767, 0, 0) # for highest photosynthetic rate in data
threat_prob(b0, b1, b2, b3, 0.34, 1, 1) # for lowest photosynthetic rate in data
```

```{r}
# Predictions for plants not listed on IUCN red list

# find plants not on red list with the lowest photosynthetic rates
lpr_pred <- anti_join(lpr_summary, redlist) %>%
  arrange(desc(avg_photo)) %>%
  tail(5)

# binary climate and human values come from literature search
pred_cols <- data.frame(climate_threatened = c(0,0,1,1,0),
                        human_threatened = c(0,0,0,0,1)) 

lpr_pred <- cbind(lpr_pred, pred_cols)

for (i in seq_along(lpr_pred$scientific_name)) {
  lpr_pred$y_hat[i] <- threat_prob(b0, b1, b2, b3, 
                                       lpr_pred$avg_photo[i],
                                       lpr_pred$climate_threatened[i],
                                       lpr_pred$human_threatened[i])
}

lpr_pred %>% 
  arrange(desc(y_hat)) %>%
  kbl(linesep = "", booktabs = TRUE, col.names = c("Speices", "Photo Rate", "Climate", "Human", "ˆy")) %>%
  kable_styling(bootstrap_options = c("striped", "condensed"),
                latex_options = c("striped", "hold_position"), full_width = TRUE)
```

# Thoughts and Conclusions

-   do these results support your hypothesis, why or why not
-   discuss uncertainty (std error)
-   discuss limitations
